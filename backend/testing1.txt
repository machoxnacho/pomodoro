docker buildx build \
  --platform linux/amd64 \
  -t 900546069136.dkr.ecr.us-east-1.amazonaws.com/smiski-backend:latest \
  --push .

# ---- Frontend Build Stage ----
FROM node:18-alpine AS frontend
WORKDIR /frontend

# Copy only frontend-specific files
COPY package.json package-lock.json ./
COPY public/ ./public/
COPY src/ ./src/

# Install dependencies and build the React app
RUN npm install
RUN npm run build

# ---- Backend Build Stage ----
FROM node:18-alpine AS backend
WORKDIR /backend

# Copy backend files
COPY backend/package.json backend/package-lock.json ./
COPY backend/ ./

# Copy built frontend into backend/public
COPY --from=frontend /frontend/build ./public

# Install backend dependencies
RUN npm install

# ---- Final Stage ----
FROM node:18-alpine
WORKDIR /app

# Copy everything from backend stage into final image
COPY --from=backend /backend .

EXPOSE 5000
CMD ["node", "server.js"]
