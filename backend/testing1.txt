

docker buildx build \
  --platform linux/amd64 \
  -t 900546069136.dkr.ecr.us-east-1.amazonaws.com/smiski-backend:latest \
  --push .


# ---- Frontend build stage ----
FROM node:18-alpine AS frontend
WORKDIR /app

# Copy package files and frontend source
COPY package.json package-lock.json ./
COPY ./src ./src
COPY ./public ./public

# Debug: List files in /app and /app/src to verify copy
RUN ls -la /app
RUN ls -la /app/src

# Install dependencies and build React app
RUN npm install
RUN npm run build

# ---- Backend build stage ----
FROM node:18-alpine AS backend
WORKDIR /app

# Copy backend files
COPY ./backend ./backend
COPY ./backend/package.json ./backend/package-lock.json ./backend/

# Copy built frontend files into backend/public
COPY --from=frontend /app/build ./backend/public

# Install backend dependencies and build if applicable
WORKDIR /app/backend
RUN npm install
# Uncomment next line if you have a backend build step
# RUN npm run build

# ---- Final stage ----
FROM node:18-alpine
WORKDIR /app

# Copy everything from backend stage
COPY --from=backend /app/backend .

EXPOSE 5000
CMD ["node", "server.js"]


