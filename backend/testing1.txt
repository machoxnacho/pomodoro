

docker buildx build \
  --platform linux/amd64 \
  -t 900546069136.dkr.ecr.us-east-1.amazonaws.com/smiski-backend:latest \
  --push .

# ---- Frontend build ----
FROM node:18-alpine as frontend
WORKDIR /app
COPY ./src ./src
WORKDIR /app/src
RUN npm install && npm run build

# ---- Backend build ----
FROM node:18-alpine as backend
WORKDIR /app
COPY ./backend ./backend
COPY --from=frontend /app/src/build ./backend/public
WORKDIR /app/backend
RUN npm install

# ---- Final image ----
FROM node:18-alpine
WORKDIR /app
COPY --from=backend /app/backend .
ENV NODE_ENV=production
EXPOSE 5000
CMD ["node", "server.js"]
