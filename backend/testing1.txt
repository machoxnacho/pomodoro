

docker buildx build \
  --platform linux/amd64 \
  -t 900546069136.dkr.ecr.us-east-1.amazonaws.com/smiski-backend:latest \
  --push .


# ---- Frontend build stage ----
FROM node:18-alpine AS frontend

WORKDIR /app

# Copy frontend source and public assets
COPY ./src ./src
COPY ./public ./public

# Copy frontend package files (if separate), else copy root package.json if frontend deps are there
COPY package.json package-lock.json ./

# Install frontend dependencies
RUN npm install

# Build the React app (output will be in /app/build)
RUN npm run build --prefix ./src

# ---- Backend build stage ----
FROM node:18-alpine AS backend

WORKDIR /app

# Copy backend source
COPY ./backend ./backend

# Copy backend package files (important for npm install)
COPY ./backend/package.json ./backend/package-lock.json ./backend/

# Copy built frontend from previous stage into backend/public
COPY --from=frontend /app/src/build ./backend/public

WORKDIR /app/backend

# Install backend dependencies
RUN npm install

# ---- Final image ----
FROM node:18-alpine

WORKDIR /app

# Copy backend including built frontend
COPY --from=backend /app/backend .

EXPOSE 5000

CMD ["node", "server.js"]





> [frontend 7/7] RUN npm run build --prefix ./src:
0.692 npm error code ENOENT
0.692 npm error syscall open
0.694 npm error path /app/src/package.json
0.695 npm error errno -2
0.695 npm error enoent Could not read package.json: Error: ENOENT: no such file or directory, open '/app/src/package.json'
0.695 npm error enoent This is related to npm not being able to find a file.
0.695 npm error enoent
0.698 npm error A complete log of this run can be found in: /root/.npm/_logs/2025-08-06T16_43_25_611Z-debug-0.log
------

 1 warning found (use docker --debug to expand):
 - DuplicateStageName: Duplicate stage name "frontend", stage names should be unique (line 6)
Dockerfile:21
--------------------
  19 |     
  20 |     # Build the React app (output will be in /app/build)
  21 | >>> RUN npm run build --prefix ./src
  22 |     
  23 |     # ---- Backend build stage ----
--------------------
ERROR: failed to build: failed to solve: process "/bin/sh -c npm run build --prefix ./src" did not complete successfully: exit code: 254

View build details: docker-desktop://dashboard/build/relaxed_diffie/relaxed_diffie0/rqx9nj6encyl95xfmb30rjmvr
