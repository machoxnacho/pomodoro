

docker buildx build \
  --platform linux/amd64 \
  -t 900546069136.dkr.ecr.us-east-1.amazonaws.com/smiski-backend:latest \
  --push .

# ---- Frontend build stage ----
FROM node:18-alpine AS frontend

WORKDIR /app

# Copy package.json and package-lock.json to install dependencies
COPY package.json package-lock.json ./

# Copy React app source and public folder
COPY ./src ./src
COPY ./public ./public

# Install frontend dependencies
RUN npm install

# Build the React app
RUN npm run build

# ---- Backend build stage ----
FROM node:18-alpine AS backend

WORKDIR /app/backend

# Copy backend source and backend package files
COPY ./backend/package.json ./backend/package-lock.json ./
COPY ./backend ./ 

# Copy built frontend assets from frontend stage to backend public folder
COPY --from=frontend /app/build ./public

# Install backend dependencies
RUN npm install

# (Optional) If you have backend build scripts, run here, e.g.:
# RUN npm run build

# ---- Final stage ----
FROM node:18-alpine

WORKDIR /app

# Copy backend with built frontend from backend stage
COPY --from=backend /app/backend .

# Expose backend port
EXPOSE 5000

# Start the backend server
CMD ["node", "server.js"]

