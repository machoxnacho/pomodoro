# ---- Frontend Build Stage ----
FROM node:18-alpine AS frontend
WORKDIR /app

# Copy React app dependencies and source code
COPY package.json package-lock.json ./
COPY public ./public
COPY src ./src

# Debugging: list files and check index.tsx to verify correct copy
RUN ls -la ./src
RUN cat ./src/index.tsx

# Install dependencies and build React app
RUN npm install
RUN npm run build

# ---- Backend Build Stage ----
FROM node:18-alpine AS backend
WORKDIR /app/backend

# Copy backend files and package files
COPY backend/package.json backend/package-lock.json ./
COPY backend ./ 

# Copy frontend build output from frontend stage into backend public folder
COPY --from=frontend /app/build ./public

# Install backend dependencies
RUN npm install

# ---- Final Stage ----
FROM node:18-alpine
WORKDIR /app

# Copy backend (with frontend build inside public) to final image
COPY --from=backend /app/backend .

EXPOSE 5000
CMD ["node", "server.js"]
